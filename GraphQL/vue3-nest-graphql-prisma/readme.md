[Vue3+Nest+GraphQL+Prisma ÂÖ•Èó®ÂÖ®Ê†àÂºÄÂèëÂõæ‰π¶ÁÆ°ÁêÜÁ≥ªÁªü](#top)

- [Project setup- Server](#project-setup--server)
- [NestÈõÜÊàêGraphQL](#nestÈõÜÊàêgraphql)
  - [ÁîüÊàêTypeScriptÂÆö‰πâ-Generate Typescript](#ÁîüÊàêtypescriptÂÆö‰πâ-generate-typescript)
  - [È™åËØÅ](#È™åËØÅ)
- [Prisma ORM + MongoDB](#prisma-orm--mongodb)
  - [Prisma setup](#prisma-setup)
  - [Use Prisma Client in your NestJS services](#use-prisma-client-in-your-nestjs-services)
  - [GraphQLÁ±ªÂûãÊ†°È™åTSÊ®°Âûã- prisma-nestjs-graphql](#graphqlÁ±ªÂûãÊ†°È™åtsÊ®°Âûã--prisma-nestjs-graphql)
- [Front End- vue](#front-end--vue)
  - [Setup](#setup)
  - [Integration GraphQL to project - Vue Apollo](#integration-graphql-to-project---vue-apollo)
  - [CORS issue](#cors-issue)

-------------------------------------------------------

## Project setup- Server

- `npm i -g @nestjs/cli`
- `nest new project-name`
- ÊâìÂºÄÊµèËßàÂô®Âπ∂ÂØºËà™Âà∞ `http://localhost:3000/`
- `nest g resource books`

```
‚îú‚îÄ‚îÄ üìÇclient/
|     ‚îú‚îÄ‚îÄ üìÇsrc/
|     ‚îÇ   ‚îú‚îÄ‚îÄ üìÇservice/
|     ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ üìÑindex.ts
|     ‚îÇ   ‚îú‚îÄ‚îÄ üìÑapp.vue
|     ‚îÇ   ‚îî‚îÄ‚îÄ üìÑmain.ts
‚îú‚îÄ‚îÄ üìÇserver/
|     ‚îú‚îÄ‚îÄ üìÇprisma/
|     ‚îÇ   ‚îú‚îÄ‚îÄ üìÑprisma.service.ts
|     ‚îÇ   ‚îú‚îÄ‚îÄ üìÑschema.prisma
|     ‚îÇ   ‚îî‚îÄ‚îÄ üìÑseed.ts
|     ‚îú‚îÄ‚îÄ üìÇsrc/
|     ‚îÇ   ‚îú‚îÄ‚îÄ üìÇ@generated/
|     ‚îÇ   ‚îú‚îÄ‚îÄ üìÇauthors/
|     ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑauthors.module.ts
|     ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ üìÑauthors.service.ts
|     ‚îÇ   ‚îú‚îÄ‚îÄ üìÇbooks/
|     ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÇentities/
|     ‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ book.entity.ts
|     ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑbooks-author.resolver.ts
|     ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑbooks.graphql
|     ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑbooks.module.ts
|     ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑbooks.resolver.ts
|     ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ üìÑbooks.service.ts
|     ‚îÇ   ‚îú‚îÄ‚îÄ app.controller.ts       - A basic controller with a single route Â∏¶ÊúâÂçï‰∏™Ë∑ØÁî±ÁöÑÂü∫Êú¨ÊéßÂà∂Âô®
|     ‚îÇ   ‚îú‚îÄ‚îÄ app.module.ts           - The root module of the application Â∫îÁî®Á®ãÂ∫èÁöÑÊ†πÊ®°Âùó
|     ‚îÇ   ‚îú‚îÄ‚îÄ app.service.ts          - A basic service with a single method Â∏¶ÊúâÂçï‰∏™ÊñπÊ≥ïÁöÑÂü∫Êú¨ÊúçÂä°
|     ‚îÇ   ‚îú‚îÄ‚îÄ main.ts                 - The entry file of the application which uses the core function NestFactory to create a Nest application instance Â∫îÁî®Á®ãÂ∫èÂÖ•Âè£Êñá‰ª∂„ÄÇÂÆÉ‰ΩøÁî® NestFactory Áî®Êù•ÂàõÂª∫ Nest Â∫îÁî®ÂÆû‰æã
```

[‚¨Ü back to top](#top)

## NestÈõÜÊàêGraphQL

- ÂÜÖÁΩÆÁöÑ `@nestjs/graphql`
- Nest Êèê‰æõ‰∫Ü‰∏§ÁßçÊûÑÂª∫ GraphQL Â∫îÁî®Á®ãÂ∫èÁöÑÊñπÂºè
  - Ê®°Âºè‰ºòÂÖà: ‰ΩøÁî®GraphQL SDLÔºàÊ®°ÂºèÂÆö‰πâËØ≠Ë®ÄÔºâ
  - ‰ª£Á†Å‰ºòÂÖà: ‰ªÖ‰ΩøÁî®Ë£ÖÈ•∞Âô®Âíå TypeScript Á±ªÊù•ÁîüÊàêÁõ∏Â∫îÁöÑ GraphQL schema
1. `npm i @nestjs/graphql @nestjs/apollo graphql apollo-server-express`
2. Apollo playground:
   1. ÈÖçÁΩÆgraphqlÔºåÂú®'app.module.ts'‰∏≠Âä†ÂÖ•
   2. `http://localhost:3000/graphql`      --> graphql playground

```ts
import { Module } from '@nestjs/common';
+import { GraphQLModule } from '@nestjs/graphql';
+import { ApolloDriver, ApolloDriverConfig } from '@nestjs/apollo';
@Module({
  imports: [
+    GraphQLModule.forRoot<ApolloDriverConfig>({
+      driver: ApolloDriver,
       typePaths: ['./**/*.graphql'],     // Ê®°Âºè‰ºòÂÖà
+    }),
  ],
})
export class AppModule {}
```

4. Apollo Sandbox
   1. ÈÖçÁΩÆgraphqlÔºåÂú®'app.module.ts'‰∏≠Âä†ÂÖ•
   2.  `http://localhost:3000/graphql`      --> graphql Sandbox

```ts
import { ApolloDriver, ApolloDriverConfig } from '@nestjs/apollo';
import { ApolloServerPluginLandingPageLocalDefault } from '@apollo/server/plugin/landingPage/default';
@Module({
  imports: [
    BooksModule,
    GraphQLModule.forRoot<ApolloDriverConfig>({
      driver: ApolloDriver,
      typePaths: ['./**/*.graphql'],
      playground: false,
      plugins: [ApolloServerPluginLandingPageLocalDefault()],
    }),
  ],
  controllers: [AppController],
  providers: [AppService],
})
export class AppModule {}
```

![ApolloQuery](ApolloQuery.png)
![Apollomutation](Apollomutation.png)

[‚¨Ü back to top](#top)

### ÁîüÊàêTypeScriptÂÆö‰πâ-Generate Typescript

1. create 'generate-typings.ts' in root directory
2. `npm i ts-morph -D`
3. run `ts-node generate-typings` command line, will generate 'graphql.ts' in root directory
4. `"start:dev": "nest start --watch"`

### È™åËØÅ

- [ÁÆ°ÈÅìÁöÑÂ∫îÁî®Âú∫ÊôØ-È™åËØÅ](https://docs.nestjs.cn/10/pipes): ÂØπËæìÂÖ•Êï∞ÊçÆËøõË°åÈ™åËØÅÔºåÂ¶ÇÊûúÈ™åËØÅÊàêÂäüÁªßÁª≠‰º†ÈÄí; È™åËØÅÂ§±Ë¥•ÂàôÊäõÂá∫ÂºÇÂ∏∏
- Á±ªÈ™åËØÅÂô®- 'class-validator':
  1. `npm i --save class-validator class-transformer`
  2. modify 'src\books\dto\create-book.input.ts'
- [ÂÖ®Â±ÄÁÆ°ÈÅì](https://docs.nestjs.cn/10/pipes?id=%e5%85%a8%e5%b1%80%e7%ae%a1%e9%81%93)
  - modify 'src\main.ts'
- ![È™åËØÅ](È™åËØÅ.png)

```ts
// Á±ªÈ™åËØÅÂô® src\books\dto\create-book.input.ts
import { CreateBookInput } from '../../graphql';
import { MinLength } from 'class-validator';
export class CreateBookDto extends CreateBookInput{
    @MinLength(1)
    name: string;
}
//ÂÖ®Â±ÄÁÆ°ÈÅì src\main.ts
import { ValidationPipe } from '@nestjs/common';
async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  app.useGlobalPipes(new ValidationPipe());
  await app.listen(3000);
}
```

```
mutation Mutation($createBookInput: CreateBookInput!) {
  createBook(createBookInput: $createBookInput) {
    id
    name
    author {
      name
    }
  }
}
{
  "createBookInput": {
    "authorId": "1",
    "name": "2",
    "type": "3"
  }
}
```

[‚¨Ü back to top](#top)

## Prisma ORM + MongoDB

### Prisma setup

1. `npm install prisma -D`
   - `npm install prisma typescript ts-node @types/node --save-dev`
2. `npx prisma init` - set up Prisma ORM project by creating your Prisma Schema file
   1. creates a new directory called 'prisma' that contains a file called **'schema.prisma'**, which contains the Prisma schema with your database connection variable and schema models
   2. creates the **'.env'** file
   3. modify 'server\prisma\schema.prisma' and 'server\.env' file
   4. if password contains special characters which will be URL-encoded: `encodeURIComponent("a%c")`
3. `npm install @prisma/client`
   1. ![prismaclient](prismaclient.png)
   2. `npx prisma generate` -> initial prisma client
   3. Querying the database
4. [seed database in Prisma ORM](https://www.prisma.io/docs/orm/prisma-migrate/workflows/seeding): ÂàùÂßãÂåñÊï∞ÊçÆ
   1. Create a new file named 'seed.ts' inn prisma directory
   2. Add the `prisma.seed` field to 'package.json' file
   3. `npx prisma db seed`

[‚¨Ü back to top](#top)

### Use Prisma Client in your NestJS services

- [Use Prisma Client in your NestJS services](https://docs.nestjs.com/recipes/prisma#use-prisma-client-in-your-nestjs-services)
- create a new file: 'prisma\prisma.service.ts'

```ts
import { Injectable, OnModuleInit } from '@nestjs/common';
import { PrismaClient } from '@prisma/client';
@Injectable()
export class PrismaService extends PrismaClient implements OnModuleInit {
  async onModuleInit() {
    await this.$connect();
  }
}
```

### GraphQLÁ±ªÂûãÊ†°È™åTSÊ®°Âûã- prisma-nestjs-graphql

1. `npm i prisma-nestjs-graphql -D`
   - [prisma-nestjs-graphql](https://github.com/unlight/prisma-nestjs-graphql#readme): Generate object types, inputs, args, etc. from prisma schema file for usage with @nestjs/graphql module
2. add following to  `prisma\schema.prisma`
3. `npm run prisma:generate`
4. `npm i graphql-type-json`
5. modify 'src\books\books.resolver.ts' and 'src\books\books-author.resolver.ts'
6. delete 'src\books\dto'

```ts
// prisma\schema.prisma
generator nestgraphql {
    provider = "node node_modules/prisma-nestjs-graphql"
    output = "../src/@generated/prisma-nestjs-graphql"
    fields_Validator_from = "class-Validator"
    fields_Validator_input = true
}
model Book {
  id String @id @default(auto()) @map("_id") @db.ObjectId
  /// @Validator.MinLength(1)
  name String @unique
  type String?
  author Author @relation(fields: [authorId], references: [id])
  authorId String  @db.ObjectId
}
model Author {
  id     String @id @default(auto()) @map("_id") @db.ObjectId
  name   String
  // 1 Áî∑ÊÄß 2 Â•≥ÊÄß
  gender Int
  /// @Validator.IsEmail()
  email  String
  books  Book[]
}
```

[‚¨Ü back to top](#top)

## Front End- vue

### Setup

1. `npm create vite@latest`
2. [element-plus](https://element-plus.org/zh-CN/guide/installation.html)
   1. `npm i element-plus`
   2. modify 'client\src\main.ts'

```ts
import ElementPlus from 'element-plus'
import 'element-plus/dist/index.css'

createApp().use(ElementPlus).mount('#app')
```

[‚¨Ü back to top](#top)

### Integration GraphQL to project - Vue Apollo

- [Vue Apollo: Effortless GraphQL in your Vue app](https://apollo.vuejs.org/): integrates apollo in your Vue components with declarative queries
1. `npm i graphql graphql-tag @apollo/client`
2. create an ApolloClient instance in 'client\src\main.ts'
3. VS Code IDE integration
    1. install Apollo GraphQL extension
    2. creating a 'apollo.config.js' file in the root folder of the Vue project
4. [Composition API Method](https://apollo.vuejs.org/guide-composable/setup.html)
   1. `npm install --save @vue/apollo-composable`
   2. Connect Apollo Client to Vue

```ts
//client\src\main.ts
import { createApp, provide, h } from 'vue'
import './style.css'
import App from './App.vue'
import ElementPlus from 'element-plus'
import 'element-plus/dist/index.css'
import { ApolloClient, createHttpLink, InMemoryCache } from '@apollo/client/core'
import { provideApolloClient } from "@vue/apollo-composable";
// HTTP connection to the API
const httpLink = new createHttpLink ({
    // You should use an absolute URL here
    uri: 'http://localhost:3000/graphql',
  })
  // Cache implementation
  const cache = new InMemoryCache()
  // Create the apollo client
  const apolloClient = new ApolloClient({
    link: httpLink,
    cache,
  })
  createApp({
    setup() {
      provideApolloClient(apolloClient)
    },
    render:() => h(App)
  }).use(ElementPlus).mount('#app')
//client\apollo.config.js
module.exports = {
    client: {
      service: {
        name: 'my-app',
        // URL to the GraphQL API
        url: 'http://localhost:3000/graphql',
      },
      // Files processed by the extension
      includes: [
        'src/**/*.vue',
        'src/**/*.js',
      ],
    },
  }
```

5. [Fetching data-query+mutations](https://apollo.vuejs.org/guide-composable/query.html)
   1. create 'client\src\service\index.ts'
   2. using in App.vue: `import { useBooks, useAuthors, useAddAuthor, useAddBook } from './service/index'`

```ts
//client\src\service\index.ts
import { useQuery, useMutation } from '@vue/apollo-composable'
import gql from 'graphql-tag'
export const useBooks = () => {
    const { result, refetch } = useQuery(gql`
        query getBooks {
          books {
            id
            name
            type
            author {
              name
            }
          }
        }
      `)
  return { result, refetch }
}
export const useAuthors = () => {
  const { result, refetch } = useQuery(gql`
    query getAuthors {
      authors {
        id
        name
      }
    }
  `)
  return { result, refetch }
}
export const useAddAuthor = () => {
  const { mutate, onDone } = useMutation(gql`
    mutation createAuthor ($createAuthorInput: CreateAuthorInput!) {
      createAuthor (createAuthorInput: $createAuthorInput) {
        id
      }
    }
  `)
  return { mutate, onDone}
}
export const useAddBook = () => {
  const { mutate, onDone } = useMutation(gql`
    mutation createBook ($createBookInput: CreateBookInput!) {
      createBook (createBookInput: $createBookInput) {
        id
      }
    }
  `)
  return { mutate, onDone}
}
```

[‚¨Ü back to top](#top)

### CORS issue

- nest server side: https://docs.nestjs.com/security/cors
  - add `app.enableCors();` to 'server\src\main.ts'
- client side: https://github.com/apollographql/apollo-client/issues/8358

```ts
// client\src\main.ts
const httpLink = new HttpLink ({
    // You should use an absolute URL here
    uri: 'http://localhost:3000/graphql',
    fetchOptions: {
        mode: 'no-cors',  // no-cors, *cors, same-origin
    },
  })
```

[‚¨Ü back to top](#top)

> References
- [nestjs-official](https://docs.nestjs.com/)
- [Nest‰∏≠ÊñáÊâãÂÜå](https://docs.nestjs.cn/10/introduction)
- https://www.bilibili.com/video/BV1K44y197Za
- ÊàëÁöÑÊñ∞ÊïôÁ®ã0Âà∞1Âª∫Á´ôÂÆûÊàòÔºöhttps://luobogor.gitee.io/2024/03/06/build-gpts-website-01-gpts-scraping?utm_source=bilibili
- ‰ª£Á†Å‰ªìÂ∫ìÔºöhttps://github.com/luobogor/stars-books-admin
- [NestÂÆòÊñπÊñáÊ°£](https://docs.nestjs.com)
- [Nest‰∏≠ÊñáÊñáÊ°£](http://static.kancloud.cn/juukee/nestjs/2666734)
- [ËøêË°å‰∏Ä‰∏™Express GraphQLÊúçÂä°Âô®](https://graphql.bootcss.com/graphql-js/run)
- [Prisma MongoDB ÂÖ•Èó®](https://www.prisma.io/docs/getting-started/setup-prisma/start-from-scratch/mongodb-typescript-mongodb)
- [Prisma CLI](https://www.prisma.io/docs/reference/api-reference/command-reference)
- [Prisma Client API](https://www.prisma.io/docs/reference/api-reference/prisma-client-reference)
- [Prisma Seed](https://www.prisma.io/docs/guides/database/seed-database)
- [Vue Apollo ÂÆâË£Ö](https://v4.apollo.vuejs.org/guide/installation.html#compatibility)
- [Vue Apollo Êü•ËØ¢ API](https://v4.apollo.vuejs.org/guide-composable/query.html)
- [GraphQL Server Example](https://github.com/prisma/prisma-examples/tree/latest/typescript/graphql-nexus#getting-started)